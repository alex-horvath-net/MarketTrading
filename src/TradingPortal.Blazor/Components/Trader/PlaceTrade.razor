@page "/trader/place-trade"
@using Business.Domain
@using Business.Experts.Trader.PlaceTrade
@using System.ComponentModel.DataAnnotations
@inject Business.Experts.Trader.Trader trader
@inject Business.Experts.IdentityManager.IdentityManager identityManager
@inject ILogger<PlaceTrade> Logger

<PageTitle>New Trade</PageTitle>

<div class="card shadow-sm p-4 mt-3">
    <h2 class="text-primary">📈 Place a New Trade</h2>

    <EditForm Model="inputModel" OnValidSubmit="SubmitTrade">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Instrument</label>
                <InputText @bind-Value="inputModel.Instrument" class="form-control" />
                <ValidationMessage For="@(() => inputModel.Instrument)" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Side</label>
                <InputSelect @bind-Value="inputModel.Side" class="form-select">
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                </InputSelect>
            </div>

            <div class="col-md-3">
                <label class="form-label">Quantity</label>
                <InputNumber @bind-Value="inputModel.Quantity" class="form-control" />
                <ValidationMessage For="@(() => inputModel.Quantity)" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Order Type</label>
                <InputSelect @bind-Value="inputModel.OrderType" class="form-select">
                    <option value="Market">Market</option>
                    <option value="Limit">Limit</option>
                    <option value="Stop">Stop</option>
                    <option value="StopLimit">Stop-Limit</option>
                </InputSelect>
            </div>

            @if (inputModel.OrderType != OrderType.Market)
            {
                <div class="col-md-4">
                    <label class="form-label">Price</label>
                    <InputNumber @bind-Value="inputModel.Price" class="form-control" />
                    <ValidationMessage For="@(() => inputModel.Price)" />
                </div>
            }

            <div class="col-md-4">
                <label class="form-label">Time In Force</label>
                <InputSelect @bind-Value="inputModel.TimeInForce" class="form-select">
                    <option value="Day">Day</option>
                    <option value="GTC">GTC</option>
                    <option value="IOC">IOC</option>
                </InputSelect>
            </div>

            <div class="col-md-6">
                <label class="form-label">Strategy Tag</label>
                <InputText @bind-Value="inputModel.StrategyCode" class="form-control" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Portfolio ID</label>
                <InputText @bind-Value="inputModel.PortfolioCode" class="form-control" />
            </div>

            <div class="col-md-12">
                <label class="form-label">User Notes</label>
                <InputTextArea @bind-Value="inputModel.UserComment" class="form-control" rows="2" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Requested Execution Time (UTC)</label>
                <InputDate @bind-Value="inputModel.ExecutionRequestedForUtc" class="form-control" />
            </div>
        </div>

        <div class="mt-4 text-end">
            <button class="btn btn-success px-4" type="submit">💼 Submit Trade</button>
        </div>
    </EditForm>

    @if (!string.IsNullOrWhiteSpace(result))
    {
        <div class="alert @alertCssClass mt-4">@result</div>
    }
</div>

<div class="d-flex justify-content-between align-items-center mt-5 mb-2">
    <h5 class="text-secondary">📋 Recently Submitted Trades</h5>
    <div class="d-flex gap-2">
        <InputDate @bind-Value="filterFromDate" class="form-control form-control-sm" style="width: 160px" />
        <InputDate @bind-Value="filterToDate" class="form-control form-control-sm" style="width: 160px" />
        <InputText @bind-Value="filterInstrument" class="form-control form-control-sm" style="width: 150px" placeholder="Instrument" />
        <InputSelect @bind-Value="filterSide" class="form-select form-select-sm" style="width: 120px">
            <option value="">All</option>
            <option value="Buy">Buy</option>
            <option value="Sell">Sell</option>
        </InputSelect>
        <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyFilters">Apply</button>
    </div>
</div>

@if (filteredTrades.Any())
{
    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Instrument</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in filteredTrades)
                {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.Instrument</td>
                        <td>@t.Side</td>
                        <td>@t.Quantity</td>
                        <td>@t.OrderType</td>
                        <td>@(t.Price?.ToString("F2") ?? "-")</td>
                        <td>@t.SubmittedAtUtc.ToString("u")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mt-2 text-muted small">
            <strong>Total:</strong> @filteredTrades.Count |
            <strong>Buy:</strong> @filteredTrades.Where(t => t.Side == TradeSide.Buy).Sum(t => t.Quantity) |
            <strong>Sell:</strong> @filteredTrades.Where(t => t.Side == TradeSide.Sell).Sum(t => t.Quantity)
        </div>
    </div>
}

@code {
    private PlaceTradeInputModel inputModel = new();
    private PlaceTradeViewModel viewModel = new();
    private string? result;
    private string alertCssClass = "alert-info";

    private List<Trade> allTrades = new();
    private List<Trade> filteredTrades = new();
    private string filterInstrument = "";
    private string filterSide = "";
    private DateTime? filterFromDate;
    private DateTime? filterToDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadTrades();
    }

    private async Task LoadTrades()
    {
        allTrades = await trader.GetRecentTradesAsync();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        filteredTrades = allTrades
            .Where(t => string.IsNullOrWhiteSpace(filterInstrument) || t.Instrument.Contains(filterInstrument, StringComparison.OrdinalIgnoreCase))
            .Where(t => string.IsNullOrWhiteSpace(filterSide) || t.Side.ToString() ==  filterSide)
            .Where(t => !filterFromDate.HasValue || t.SubmittedAtUtc >= filterFromDate)
            .Where(t => !filterToDate.HasValue || t.SubmittedAtUtc <= filterToDate.Value.Date.AddDays(1).AddTicks(-1))
            .ToList();
    }

    private async Task SubmitTrade()
    {
        try
        {
           

            var id = await trader.PlaceTrade(inputModel, Token);
            result = $"✅ Trade submitted: {id}";
            alertCssClass = "alert-success";
            inputModel = new();
            await LoadTrades();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Trade failed");
            result = $"❌ {ex.Message}";
            alertCssClass = "alert-danger";
        }
    }

    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }
    CancellationTokenSource tcs = new();
    CancellationToken Token => tcs.Token;
}
