@page "/trader/place-trade"
@using Business.Domain
@using Business.Experts.Trader.PlaceTrade
@using System.ComponentModel.DataAnnotations
@inject Business.Experts.Trader.Trader trader
@inject Business.Experts.IdentityManager.IdentityManager identityManager
@inject ILogger<PlaceTrade> Logger

<PageTitle>New Trade</PageTitle>

<div class="card shadow-sm p-4 mt-3">
    <h2 class="text-primary">📈 Place a New Trade</h2>

    <EditForm Model="placeTradeInputModel" OnValidSubmit="SubmitTrade">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-danger" />

        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Instrument</label>
                <InputText @bind-Value="placeTradeInputModel.Instrument" class="form-control" />
                <ValidationMessage For="@(() => placeTradeInputModel.Instrument)" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Side</label>
                <InputSelect @bind-Value="placeTradeInputModel.Side" class="form-select">
                    <option value="Buy">Buy</option>
                    <option value="Sell">Sell</option>
                </InputSelect>
            </div>

            <div class="col-md-3">
                <label class="form-label">Quantity</label>
                <InputNumber @bind-Value="placeTradeInputModel.Quantity" class="form-control" />
                <ValidationMessage For="@(() => placeTradeInputModel.Quantity)" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Order Type</label>
                <InputSelect @bind-Value="placeTradeInputModel.OrderType" class="form-select">
                    <option value="Market">Market</option>
                    <option value="Limit">Limit</option>
                    <option value="Stop">Stop</option>
                    <option value="StopLimit">Stop-Limit</option>
                </InputSelect>
            </div>

            @if (placeTradeInputModel.OrderType != OrderType.Market) {
                <div class="col-md-4">
                    <label class="form-label">Price</label>
                    <InputNumber @bind-Value="placeTradeInputModel.Price" class="form-control" />
                    <ValidationMessage For="@(() => placeTradeInputModel.Price)" />
                </div>
            }

            <div class="col-md-4">
                <label class="form-label">Time In Force</label>
                <InputSelect @bind-Value="placeTradeInputModel.TimeInForce" class="form-select">
                    <option value="Day">Day</option>
                    <option value="GTC">GTC</option>
                    <option value="IOC">IOC</option>
                </InputSelect>
            </div>

            <div class="col-md-6">
                <label class="form-label">Strategy Tag</label>
                <InputText @bind-Value="placeTradeInputModel.StrategyCode" class="form-control" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Portfolio ID</label>
                <InputText @bind-Value="placeTradeInputModel.PortfolioCode" class="form-control" />
            </div>

            <div class="col-md-12">
                <label class="form-label">User Notes</label>
                <InputTextArea @bind-Value="placeTradeInputModel.UserComment" class="form-control" rows="2" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Requested Execution Time (UTC)</label>
                <InputDate @bind-Value="placeTradeInputModel.ExecutionRequestedFor" class="form-control" />
            </div>
        </div>

        <div class="mt-4 text-end">
            <button class="btn btn-success px-4" type="submit">💼 Submit Trade</button>
        </div>
    </EditForm>

    @if (!string.IsNullOrWhiteSpace(placeTradeViewModel.Result)) {
        <div class="alert @placeTradeViewModel.AlertCssClass mt-4">@placeTradeViewModel.Result</div>
    }
</div>

<div class="d-flex justify-content-between align-items-center mt-5 mb-2">
    <h5 class="text-secondary">📋 Recently Submitted Trades</h5>
    <div class="d-flex gap-2">
        <InputDate @bind-Value="filterFromDate" class="form-control form-control-sm" style="width: 160px" />
        <InputDate @bind-Value="filterToDate" class="form-control form-control-sm" style="width: 160px" />
        <InputText @bind-Value="filterInstrument" class="form-control form-control-sm" style="width: 150px" placeholder="Instrument" />
        <InputSelect @bind-Value="filterSide" class="form-select form-select-sm" style="width: 120px">
            <option value="">All</option>
            <option value="Buy">Buy</option>
            <option value="Sell">Sell</option>
        </InputSelect>
        <button class="btn btn-sm btn-outline-secondary" @onclick="ApplyFilters">Apply</button>
    </div>
</div>

@if (filteredTrades.Any()) {
    <div class="card shadow-sm p-4 mt-3">
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Instrument</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Time</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in filteredTrades) {
                    <tr>
                        <td>@t.Id</td>
                        <td>@t.Instrument</td>
                        <td>@t.Side</td>
                        <td>@t.Quantity</td>
                        <td>@t.OrderType</td>
                        <td>@(t.Price?.ToString("F2") ?? "-")</td>
                        <td>@t.SubmittedAt.ToString("u")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mt-2 text-muted small">
            <strong>Total:</strong> @filteredTrades.Count |
            <strong>Buy:</strong> @filteredTrades.Where(t => t.Side == TradeSide.Buy).Sum(t => t.Quantity) |
            <strong>Sell:</strong> @filteredTrades.Where(t => t.Side == TradeSide.Sell).Sum(t => t.Quantity)
        </div>
    </div>
}

@code {
    private PlaceTradeInputModel placeTradeInputModel = new();
    private PlaceTradeViewModel placeTradeViewModel = new();

    private List<Trade> allTrades = new();
    private List<Trade> filteredTrades = new();

    private string filterInstrument = "";
    private string filterSide = "";
    private DateTime? filterFromDate;
    private DateTime? filterToDate;

    [CascadingParameter]
    public HttpContext? HttpContext { get; set; }
    private CancellationTokenSource tcs = new();
    private CancellationToken Token => tcs.Token;

    protected override async Task OnInitializedAsync() {
        placeTradeInputModel = new();
        placeTradeInputModel.TraderId = identityManager.GetUserName(HttpContext);
       
        allTrades = await trader.GetRecentTrades();
        ApplyFilters();
    }


    private void ApplyFilters() {
        filteredTrades = allTrades
            .Where(t => string.IsNullOrWhiteSpace(filterInstrument) || t.Instrument.Contains(filterInstrument, StringComparison.OrdinalIgnoreCase))
            .Where(t => string.IsNullOrWhiteSpace(filterSide) || t.Side.ToString() == filterSide)
            .Where(t => !filterFromDate.HasValue || t.SubmittedAt >= filterFromDate)
            .Where(t => !filterToDate.HasValue || t.SubmittedAt <= filterToDate.Value.Date.AddDays(1).AddTicks(-1))
            .ToList();
    }

    private async Task SubmitTrade() {
        placeTradeViewModel = await trader.PlaceTrade(placeTradeInputModel, Token);
        placeTradeInputModel = new();
        placeTradeInputModel.TraderId = identityManager.GetUserName(HttpContext);
        allTrades = await trader.GetRecentTrades();
        ApplyFilters();
    }
}
